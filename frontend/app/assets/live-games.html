<link rel="import" href="/assets/javascripts/bower_components/polymer/polymer.html">
<polymer-element name="new-games" attributes="liveUrl initialJson">
    <template>
        <template repeat="{{game in games}}">
            <template if="{{game.duel && game.now}}">
                <duel-card leftPlayerScore="{{game.duel.players[0].score}}"
                           leftPlayerName="{{game.duel.players[0].name}}"
                           leftPlayerId="{{game.duel.players[0].id}}"
                           rightPlayerScore="{{game.duel.players[1].score}}"
                           rightPlayerName="{{game.duel.players[1].name}}"
                           rightPlayerId="{{game.duel.players[1].id}}"
                           isLive="true"></duel-card>
            </template>
            <template if="{{game.now && !game.duel}}">
                <p>game: {{game.now.mode}} @ {{game.now.map}}, server {{game.now.server.server}}</p>
            </template>
        </template>
    </template>

    <script>
        Polymer("live-games", {
            initialJsonChanged: function(_, newValue) {
                this.gamesMap = JSON.parse(newValue);
                var newGames = [];
                for ( var j in gamesMap ) {
                    newGames.push(gamesMap[i]);
                }
                this.games = newGames;
            },
            onMessage: function(msg) {
                var obj = JSON.parse(msg.data);
                this.gamesMap[obj.now.server.server] = obj;
                var newGames = [];
                for ( var j in gamesMap ) {
                    newGames.push(gamesMap[i]);
                }
                this.games = newGames;
            },
            onClose: function() {
                setTimeout(this.liveUrlChanged.bind(this), 5000);
            },
            liveUrlChanged: function() {
                this.websocket = new WebSocket(this.liveUrl);
                this.websocket.onmessage = this.onMessage.bind(this);
                this.websocket.onclose = this.onClose.bind(this);
            }
        });
    </script>

</polymer-element>