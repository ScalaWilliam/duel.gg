<link rel="import" href="/assets/bower_components/polymer/polymer.html">
<link rel="import" href="/assets/bower_components/paper-input/paper-input.html">
<link rel="import" href="/assets/bower_components/paper-button/paper-button.html">
<link rel="import" href="/assets/bower_components/core-ajax/core-ajax.html">
<polymer-element name="d-sanchez"
                 attributes="name startTerm">
    <template>
        <style scoped>
            a { color: wheat;}
            .flexed ol {
                display:flex;
                overflow-x:scroll;
                margin:0;
                padding:0;
                list-style-type: none;
            }
            ::-webkit-scrollbar {
                  width:  0.5em;
                  height: 0.5em;
              }

            ::-webkit-scrollbar-thumb {
                background: white;
            }

            ::-webkit-scrollbar-track {
                background: slategray;
            }
            .flexed ol li {
                flex: 10 0 auto;
                margin-right:1em;
            }
            .flexed ol li a {
                display:block;
            }
            #duels ol li {
                width:20em;
            }
            a:focus {
                background:#1b325f;
                outline: 0;
            }
            paper-input {
                font-size:1.6em;
                width:10em;
                text-align: center;
            }
            paper-input /deep/ input {
                text-align: center;
            }
            .flexed.hidden {
                display:none;
            }
        </style>
        <div class="searcher">
            <paper-input label="Search for player" on-input="{{ngn}}">
            </paper-input>
            <div id="registered" class="{{ { hidden: registeredPlayers.length == 0, flexed: true } | tokenList}}">
                <h2>Registered Players</h2>
                <ol>
                <template repeat="{{player in registeredPlayers}}">
                    <li id="{{player.globalId}}" class="{{ {active: player == activeItem} | tokenList}}"><a href="/player/{{player.id}}/">
                        <h3>{{player.name}}</h3>
                        <p>{{player.gameNickname}}</p>
                    </a></li>
                </template>
                </ol>
            </div>
            <div id="players" class="{{ { hidden: otherPlayers.length == 0, flexed: true } | tokenList}}">
                <h2>Other Players</h2>
                <ol>
                    <template repeat="{{other in otherPlayers}}">
                        <li id="{{other.globalId}}" class="{{ {active: other == activeItem} | tokenList}}">
                            <a href="/player/?nickname={{other.nickname}}">{{other.nickname}}</a>
                        </li>
                    </template>
                </ol>
            </div>
            <div id="duels" class="{{ { hidden: !duels.items || (duels.items.length == 0), flexed: true } | tokenList}}">
                <h2>Duels</h2>
                <ol>
                    <template repeat="{{duel in duels.items}}">
                        <li id="{{duel.globalId}}" class="{{ {active: duel == activeItem} | tokenList}}">
                            <mini-duel-card duelId="{{duel.id}}"
                                            leftPlayerName="{{duel.leftPlayerName}}"
                                            rightPlayerName="{{duel.rightPlayerName}}"
                                            leftPlayerScore="{{duel.leftPlayerScore}}"
                                            atTime="{{duel.atTime}}"
                                            rightPlayerScore="{{duel.rightPlayerScore}}"
                                            mode="{{duel.mode}}"
                                            map="{{duel.map}}"></mini-duel-card>
                        </li>
                    </template>
                </ol>
            </div>
            <core-ajax id="primary"
                       url="http://127.0.0.1:9000/json/search/"
                       params='{"q":"vaQ"}'
                       handleAs="json"
                       on-core-response="{{handleResponse}}"></core-ajax>
            <core-ajax id="secondary"
                       url="http://127.0.0.1:9000/json/search/"
                       params='{"q":"vaQ"}'
                       handleAs="json"
                       on-core-response="{{handleResponseLazy}}"></core-ajax>
        </div>
    </template>
    <script>

        Polymer("d-sanchez", {
            ready: function() {
                this.registeredPlayers = [];
                this.otherPlayers = [];
                this.duels = { items: [] };
                var searchBox = this.shadowRoot.querySelector('paper-input');
                searchBox.focus();
                var subInput = unwrap(searchBox.shadowRoot.querySelector('input'));
                subInput.focus();
                setTimeout(function() { subInput.focus() }, 5)
            },
            startTermChanged: function(_, nv) {
                this.shadowRoot.querySelector('paper-input').value = nv;
                this.gajax(nv);
            },
            handleResponse: function(a, b, c) {
                this.registeredPlayers = b.response['registeredUsers'];
                this.otherPlayers = b.response['otherNicknames'];
                this.duels = {'items':b.response.duels};
                this.hasMore = b.response.duels['has-more'];
                this.page = b.response.duels.page;
                this.linkedList = this.registeredPlayers.concat(this.otherPlayers).concat(this.duels.items);
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                this.registeredPlayers.forEach(function(p) { p.globalId = "rp-"+hashCode(p.id);});
                this.duels.items.forEach(function(p) { p.globalId = "duel-"+hashCode(p.id);});
                this.otherPlayers.forEach(function(p) { p.globalId = "op-"+hashCode(p.nickname);});
            },
            attached: function() {
                scrollHorizons(unwrap(this.shadowRoot.querySelector ('#duels ol')));
                scrollHorizons(unwrap(this.shadowRoot.querySelector('#registered ol')));
                scrollHorizons(unwrap(this.shadowRoot.querySelector('#players ol')));
            },
            handleResponseLazy: function(a, b, c) {
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                b.response.duels.forEach(function(item) {
                    for ( var i = 0; i < this.duels.items.length; i++ ) {
                        if ( this.duels.items[i].id == item.id) return;
                    }
                    this.duels.items.push(item);
                    item.globalId = "duel-"+hashCode(item.id);
                    this.linkedList.push(item);
                }.bind(this));
            },
            gajax: function(v) {
                var ajax = this.shadowRoot.querySelector('core-ajax#primary');
                ajax.params = JSON.stringify({'q': v});
                window.history.replaceState(null, "Yay", "/search/?q="+encodeURIComponent(v));
                this.q = v;
                if (v.length >= 3) {
                    ajax.go();
                    this.activeItem = null;
                } else {
                    this.registeredPlayers = [];
                    this.otherPlayers = [];
                    this.duels = [];
                    this.linkedList = [];
                    this.page = 1;
                }
            },
            ngn: function(a,b,d) {
                this.gajax(d.value);
            },
            keyupHandler: function(event, detail, sender) {
                var searchBox = this.shadowRoot.querySelector('paper-input');
                var subInput = unwrap(searchBox.shadowRoot.querySelector('input'));
                var currentlyFocused = document.activeElement == subInput || (this.shadowRoot && this.shadowRoot.activeElement == searchBox);
                if ( event.keyCode == 83 ) {
                    if ( !currentlyFocused ) {
                        searchBox.focus();
                        subInput.focus();
                        this.activeItem = null;
                    }
                }
            },
            keypressHandler: function(event, detail, sender) {
                var ensureVisible = (function() {
                    if ( this.activeItem ) {
                        if ( this.duels.items.indexOf(this.activeItem) > -1 ) {
try {
    this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' mini-duel-card').shadowRoot.querySelector('a').focus();
}catch(e) {}

                            try {

                                this.querySelector('::shadow #' + this.activeItem.globalId + ' mini-duel-card ::shadow a').focus();
                            } catch (e) {
                            }
                        } else {

                            this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' a').focus();
                            try {this.querySelector('::shadow #' + this.activeItem.globalId + ' a').focus();
                            } catch (e) {}
                        }

                    }
                }).bind(this);
                var searchBox = this.shadowRoot.querySelector('paper-input');
                var subInput = unwrap(searchBox.shadowRoot.querySelector('input'));
                var currentlyFocused = document.activeElement == subInput || (this.shadowRoot && this.shadowRoot.activeElement == searchBox);
                if ( event.keyCode == 40 ) { // down
                    event.stopPropagation();
                    if ( currentlyFocused ) {
                        searchBox.blur();
                        subInput.blur();
                        this.activeItem = this.registeredPlayers[0] || this.otherPlayers[0] || this.duels.items[0];
                        ensureVisible();
                    } else if ( this.registeredPlayers.indexOf(this.activeItem) > -1 ) {
                        searchBox.blur();
                        subInput.blur();
                        this.activeItem = this.otherPlayers[0] || this.duels.items[0];
                        ensureVisible();
                    } else if ( this.otherPlayers.indexOf(this.activeItem) > -1 ) {
                        searchBox.blur();
                        subInput.blur();
                        this.activeItem = this.duels.items[0];
                        ensureVisible();
                    }
                }
                else if ( event.keyCode == 38 ) {// up
                    event.stopPropagation();
                    if ( this.registeredPlayers.indexOf(this.activeItem ) > -1  ) {
                        this.activeItem = null;
                    } else if ( this.otherPlayers.indexOf(this.activeItem) > - 1 ) {
                        this.activeItem = this.registeredPlayers[0];
                        ensureVisible();
                    } else if ( this.duels.items.indexOf(this.activeItem) > -1 ) {
                        this.activeItem = this.otherPlayers[0] || this.registeredPlayers[0];
                        ensureVisible();
                    }
                    if ( !currentlyFocused && !this.activeItem) {
                        searchBox.focus()
                    }
                }
                // right
                else if ( event.keyCode == 39 ) {
                    if ( this.linkedList.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.linkedList[this.linkedList.indexOf(this.activeItem) + 1] || this.activeItem;
                        ensureVisible();
                        if ( this.duels.items.indexOf(this.activeItem) == this.duels.items.length - 2 ) {
                            var ajax = this.shadowRoot.querySelector('core-ajax#secondary');
                            ajax.params = JSON.stringify({'q': this.q, 'duel-before': this.duels.items[this.duels.items.length - 1].id});
                            ajax.go();
                        }
                    }
                }
                // left
                else if ( event.keyCode == 37) {
                    if ( this.linkedList.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.linkedList[this.linkedList.indexOf(this.activeItem) - 1] || this.activeItem;
                        ensureVisible();
                    }
                }
                else if ( event.keyCode == 13) {//enter
                }
                else if ( event.keyCode == 27) { //escape
                    this.shadowRoot.querySelector('paper-input').value = '';
                }
            }
        })
    </script>
</polymer-element>