<link rel="import" href="/assets/bower_components/polymer/polymer.html">
<link rel="import" href="/assets/bower_components/paper-input/paper-input.html">
<link rel="import" href="/assets/bower_components/paper-button/paper-button.html">
<link rel="import" href="/assets/bower_components/core-ajax/core-ajax.html">
<polymer-element name="d-searcher"
                 attributes="name value1">
    <template>
        <div class="searcher">
            <paper-input label="Search for player" on-input="{{ngn}}" on-keydown="{{keypressHandler}}">
            </paper-input>
            <core-ajax
                    url="/search-player/"
                    params='{"nickname":"w00p|"}'
                    handleAs="json"
                    on-core-response="{{handleResponse}}"></core-ajax>
            <h2>{{name}}</h2>
            <template repeat="{{term in terms}}">
                <template if="{{term == selectedTerm}}">
                    <li><core-label on-click="{{dod}}"><strong>{{term}}</strong></core-label></li>
                </template>
                <template if="{{term != selectedTerm}}">
                    <li><core-label on-click="{{dod}}">{{term}}</core-label></li>
                </template>
            </template>
        </div>
    </template>
    <script>
        Polymer("d-searcher", {
            handleResponse: function(a, b, c) {
                this.terms = b.response.terms;
                this.selectedTerm = this.terms[0];
            },
            dod:function(x,a,d) {
                this.go(d.templateInstance.model.term);
            },
            ngn: function(a,b,d) {
                var ajax = this.shadowRoot.querySelector('core-ajax');
                ajax.params = JSON.stringify({'nickname': d.value});
                ajax.go()
            },
            keypressHandler: function(event, detail, sender) {
                if ( event.keyCode == 40 ) { // down
                    if ( !this.selectedTerm ) {
                        this.selectedTerm = this.terms[0];
                    } else if ( this.selectedTerm == this.terms[this.terms.length - 1]) {
                        this.selectedTerm = this.terms[0];
                    } else {
                        this.selectedTerm = this.terms[this.terms.indexOf(this.selectedTerm) + 1];
                    }
                }
                else if ( event.keyCode == 38 ) {// up
                    if ( this.selectedTerm == this.terms[0]) {
                        this.selectedTerm = this.terms[this.terms.length - 1];
                    } else if ( this.selectedTerm ) {
                        this.selectedTerm = this.terms[this.terms.indexOf(this.selectedTerm) - 1];
                    }
                    event.stopPropagation();
                }
                else if ( event.keyCode == 13) {//enter
                    this.go(this.selectedTerm);
                }
                else if ( event.keyCode == 27) { //escape
                    this.terms = [];
                    this.shadowRoot.querySelector('paper-input').value = '';
                }
            },
            go: function(term) {
                window.location = '/player/?nickname='+term;
            }
        })
    </script>
</polymer-element>