<polymer-element name="home-duels"
                 attributes="name initialGamesJson">
    <template>
            <style scoped>
                .flexed ol {
                    display:flex;
                    overflow-x:scroll;
                    margin:0;
                    padding:0;
                    height:10em;
                    overflow-y:hidden;
                    list-style-type: none;
                    flex-flow: column;
                    flex-wrap:wrap;
                }
                ::-webkit-scrollbar {
                    width:  0.5em;
                    height: 0.5em;
                }

                ::-webkit-scrollbar-thumb {
                    background: white;
                }

                ::-webkit-scrollbar-track {
                    background: slategray;
                }
                .flexed ol li {
                    flex: 10 0 auto;
                    margin-right:1em;
                }
                .flexed ol li a {
                    display:block;
                }
                #duels ol li {
                    width:20em;
                }
                a:focus {
                    background:#1b325f;
                    outline: 0;
                }
            </style>
                <div id="duels" class="flexed">
                    <h2>Latest Duels</h2>
                    <ol>
                        <template repeat="{{duel in duels}}">
                            <li id="{{duel.globalId}}" class="{{ {active: duel == activeItem} | tokenList}}">
                                <mini-duel-card duelId="{{duel.id}}"
                                                leftPlayerName="{{duel.leftPlayerName}}"
                                                rightPlayerName="{{duel.rightPlayerName}}"
                                                leftPlayerScore="{{duel.leftPlayerScore}}"
                                                rightPlayerScore="{{duel.rightPlayerScore}}"
                                                atTime="{{duel.atTime}}"
                                                mode="{{duel.mode}}"
                                                map="{{duel.map}}"></mini-duel-card>
                            </li>
                        </template>
                    </ol>
                </div>
    </template>
    <script>
        Polymer("home-duels", {
            ready: function() {
                scrollHorizons(unwrap(this.shadowRoot.querySelector('#duels ol')));
            },
            initialGamesJsonChanged: function(_, v) {
                this.duels = JSON.parse(v);
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                this.duels.forEach(function(item) {
                    item.globalId = "duel-"+hashCode(item.id);
                }.bind(this));
                this.activeItem = this.duels[0];
                var ensureVisible = (function() {
                    if ( this.activeItem ) {
                        if ( this.duels.indexOf(this.activeItem) > -1 ) {
                            try {
                                this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' mini-duel-card').shadowRoot.querySelector('a').focus();
                            }catch(e) {}
                            try {
                                this.querySelector('::shadow #' + this.activeItem.globalId + ' mini-duel-card ::shadow a').focus();
                            } catch (e) {
                            }
                        } else {

                            this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' a').focus();
                            try {this.querySelector('::shadow #' + this.activeItem.globalId + ' a').focus();
                            } catch (e) {}
                        }

                    }
                }).bind(this);
                setTimeout(ensureVisible, 100);
            },
            keypressHandler: function(event, detail, sender) {
                var ensureVisible = (function() {
                    if ( this.activeItem ) {
                        if ( this.duels.indexOf(this.activeItem) > -1 ) {
                            try {
                                this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' mini-duel-card').shadowRoot.querySelector('a').focus();
                            }catch(e) {}
                            try {
                                this.querySelector('::shadow #' + this.activeItem.globalId + ' mini-duel-card ::shadow a').focus();
                            } catch (e) {
                            }
                        } else {

                            this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' a').focus();
                            try {this.querySelector('::shadow #' + this.activeItem.globalId + ' a').focus();
                            } catch (e) {}
                        }

                    }
                }).bind(this);
                // right
                if ( event.keyCode == 39 ) {
                    if ( this.duels.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.duels[this.duels.indexOf(this.activeItem) + 1] || this.activeItem;
                        ensureVisible();
                        if ( this.duels.indexOf(this.activeItem) == this.duels.length - 2 ) {
                            window.location = '/duel/'+ this.duels[this.duels.length - 1].id+'/';
                        }
                    } else {
                        this.activeItem = this.duels[0];
                        ensureVisible();
                    }
                }
                // left
                else if ( event.keyCode == 37) {
                    if ( this.duels.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.duels[this.duels.indexOf(this.activeItem) - 1] || this.activeItem;
                        ensureVisible();
                    }
                }
            }
        })
    </script>
</polymer-element>