<polymer-element name="live-duels"
                 attributes="wsUrl currentDuelId">
    <template>
            <style scoped>
                .flexed ol {
                    display:flex;
                    overflow-x:scroll;
                    margin:0;
                    padding:0;
                    height:10em;
                    list-style-type: none;
                    flex-flow: column;
                    flex-wrap:wrap;
                }
                ::-webkit-scrollbar {
                    width:  0.5em;
                    height: 0.5em;
                }

                ::-webkit-scrollbar-thumb {
                    background: white;
                }

                ::-webkit-scrollbar-track {
                    background: slategray;
                }
                .flexed ol li {
                    flex: 10 0 auto;
                    margin-right:1em;
                }
                .flexed ol li a {
                    display:block;
                }
                #duels ol li {
                    width:20em;
                }
                a:focus {
                    background:#1b325f;
                    outline: 0;
                }
                .hidden {
                    display:none;
                }
            </style>
                <div id="duels" class="{{ { hidden: !(duels && duels.length > 0), flexed: true } | tokenList}}">
                    <h2>Live Duels</h2>
                    <ol>
                        <template repeat="{{duel in duels}}">
                            <li id="{{duel.globalId}}" class="{{ {active: duel == activeItem} | tokenList}}">
                                <mini-duel-card
                                        duelId="{{duel.id}}"
                                                leftPlayerName="{{duel.leftPlayerName}}"
                                                rightPlayerName="{{duel.rightPlayerName}}"
                                                leftPlayerScore="{{duel.leftPlayerScore}}"
                                                rightPlayerScore="{{duel.rightPlayerScore}}"
                                                atTime="{{duel.atTime}}"
                                                on-clicked-duel-card="{{clicker}}"
                                                mode="{{duel.mode}}"
                                                isLive="true"
                                                map="{{duel.map}}"
                                        class="{{ {selected:duel.id == currentDuelId} | tokenList}}"

                                        ></mini-duel-card>
                            </li>
                        </template>
                    </ol>
                </div>
        <div id="live-duel" class="{{ {hidden: !currentDuel} | tokenList}}">
            <duel-detailed-card duelId="{{currentDuel.id}}" atTime="{{currentDuel.atTime}}" leftPlayerScore="{{currentDuel.leftPlayerScore}}"
                                map="{{currentDuel.map}}" mode="{{currentDuel.mode}}" leftPlayerName="{{currentDuel.leftPlayerName}}"
                                rightPlayerScore="{{currentDuel.rightPlayerScore}}" rightPlayerName="{{currentDuel.rightPlayerName}}"
                                leftPlayerId="{{currentDuel.leftPlayerId}}"
                                scoreLog="{{currentDuel.scoreLog|ser}}"
                                rightPlayerId="{{currentDuel.rightPlayerId}}"
                    >
                <!-- -->
            </duel-detailed-card>
        </div>
    </template>
    <script>
        Polymer("live-duels", {
            ready: function() {
                scrollHorizons(unwrap(this.shadowRoot.querySelector('#duels ol')));
            },
            wsUrlChanged: function() {
                this.websocket = new WebSocket(this.wsUrl);
                this.websocket.onmessage = this.onMessage.bind(this);
                this.websocket.onclose = this.onClose.bind(this);
            },
            clicker: function(a,b,c,d) {
                this.currentDuelId = a.detail.duelId;
            },
            currentDuelIdChanged: function(_, id) {
                this.currentDuel = this.duels.filter(function(duel) { return duel.id == id; })[0];
            },
            onMessage: function(msg) {
                var resp = JSON.parse(msg.data);
                var hashCode = function(s){ return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0); };
                resp.forEach(function(item) {
                    item.globalId = "live-duel-"+hashCode(item.id+"");
                });
                this.duels = resp;
                var currentDuelExists = resp.filter(function(d) { return d.id == this.currentDuelId;}.bind(this)).length > 0;
                if ( !currentDuelExists ) {
//                    if ( this.duels.length ) {
//                        this.currentDuelId = this.duels[0].id;
//                    } else {
                        this.currentDuelId = null;
//                    }
                }
            },
            onClose: function() {
                setTimeout(this.wsUrlChanged.bind(this), 5000);
            },
            ser: function(x) {
                return JSON.stringify(x);
            }
        })
    </script>
</polymer-element>