<polymer-element name="duel-view" attributes="initialJson">
    <template><style scoped>
        a { color: wheat;}
        .flexed ol {
            display:flex;
            overflow-x:scroll;
            margin:0;
            padding:0;
            list-style-type: none;
        }
        ::-webkit-scrollbar {
            width:  0.5em;
            height: 0.5em;
        }

        ::-webkit-scrollbar-thumb {
            background: white;
        }

        ::-webkit-scrollbar-track {
            background: slategray;
        }
        .flexed ol li {
            flex: 10 0 auto;
            margin-right:1em;
        }
        .flexed ol li a {
            display:block;
        }
        #duels ol li {
            width:20em;
        }
        a:focus {
            background:#1b325f;
            outline: 0;
        }
        #duels.hidden {
            display:none;
        }
    </style>
        <div id="main-duel">
            <duel-detailed-card duelId="{{currentDuel.id}}" atTime="{{currentDuel.atTime}}" leftPlayerScore="{{currentDuel.leftPlayerScore}}"
                                map="{{currentDuel.map}}" mode="{{currentDuel.mode}}" leftPlayerName="{{currentDuel.leftPlayerName}}"
                                rightPlayerScore="{{currentDuel.rightPlayerScore}}" rightPlayerName="{{currentDuel.rightPlayerName}}"
                                leftPlayerId="{{currentDuel.leftPlayerId}}"
                                scoreLog="{{currentDuel.scoreLog|ser}}"
                                rightPlayerId="{{currentDuel.rightPlayerId}}"
                    >
                <!-- -->
            </duel-detailed-card>
        </div>
        <div id="duels" class="flexed">
        <ol>
        <template repeat="{{duel in duels}}">
            <li id="{{duel.globalId}}" class="{{ {active: duel == activeItem} | tokenList}}">
                <mini-duel-card duelId="{{duel.id}}"
                                leftPlayerName="{{duel.leftPlayerName}}"
                                rightPlayerName="{{duel.rightPlayerName}}"
                                leftPlayerScore="{{duel.leftPlayerScore}}"
                                rightPlayerScore="{{duel.rightPlayerScore}}"
                                atTime="{{duel.atTime}}"
                                mode="{{duel.mode}}"
                                map="{{duel.map}}"></mini-duel-card>
            </li>
        </template>

            <core-ajax id="before"
                       url="http://127.0.0.1:9000/json/main/"
                       params='{}'
                       handleAs="json"
                       on-core-response="{{handleResponseBefore}}"></core-ajax>
            <core-ajax id="after"
                       url="http://127.0.0.1:9000/json/main/"
                       params='{}'
                       handleAs="json"
                       on-core-response="{{handleResponseAfter}}"></core-ajax>
</ol></div>
    </template>
    <script>
        Polymer("duel-view", {
            initialJsonChanged: function(_, v) {
                var json = JSON.parse(v);
                this.duels = json.duels;
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                this.duels.forEach(function(item) {
                    item.globalId = "duel-"+hashCode(item.id);
                });

                this.currentDuel = this.duels.filter(function(item) { return item.id == json.duel.id; })[0];
                this.activeItem = this.currentDuel;
                this.currentDuelChanged.call(this);
            },
            handleResponseBefore: function(a, b, c) {
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                b.response.duels.forEach(function(item) {
                    for ( var i = 0; i < this.duels.length; i++ ) {
                        if ( this.duels[i].id == item.id) return;
                    }
                    this.duels.push(item);
                    item.globalId = "duel-"+hashCode(item.id);
                }.bind(this));
            },
            ser: function(x) {
                return JSON.stringify(x);
            },
            activeItemChanged: function(_, v) {
                this.currentDuel = this.activeItem;
                window.history.replaceState(null, null, '/duel/'+this.currentDuel.id+'/');
            },
            currentDuelChanged: function(_, v) {
                var ensureVisible = (function() {
                    if ( this.activeItem ) {
                        if ( this.duels.indexOf(this.activeItem) > -1 ) {
                            try {
                                this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' mini-duel-card').shadowRoot.querySelector('a').focus();
                            }catch(e) {}
                            try {
                                this.querySelector('::shadow #' + this.activeItem.globalId + ' mini-duel-card ::shadow a').focus();
                            } catch (e) {
                            }
                        } else {
try {
                            this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' a').focus();} catch (e) {}
                            try {this.querySelector('::shadow #' + this.activeItem.globalId + ' a').focus();
                            } catch (e) {}
                        }

                    }
                }).bind(this);
                setTimeout(ensureVisible, 100);
            },
            handleResponseAfter: function(a, b, c) {
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                b.response.duels.reverse().forEach(function(item) {
                    for ( var i = 0; i < this.duels.length; i++ ) {
                        if ( this.duels[i].id == item.id) return;
                    }
                    this.duels.unshift(item);
                    item.globalId = "duel-"+hashCode(item.id);
                }.bind(this));
            },
            keypressHandler: function(event, detail, sender) {
                var ensureVisible = (function() {
                    if ( this.activeItem ) {
                        if ( this.duels.indexOf(this.activeItem) > -1 ) {
                            try {
                                this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' mini-duel-card').shadowRoot.querySelector('a').focus();
                            }catch(e) {}
                            try {
                                this.querySelector('::shadow #' + this.activeItem.globalId + ' mini-duel-card ::shadow a').focus();
                            } catch (e) {
                            }
                        } else {
try {
    this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' a').focus();
} catch (e) {}
                            try {this.querySelector('::shadow #' + this.activeItem.globalId + ' a').focus();
                            } catch (e) {}
                        }

                    }
                }).bind(this);
                // right
                if ( event.keyCode == 39 ) {
                    if ( this.duels.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.duels[this.duels.indexOf(this.activeItem) + 1] || this.activeItem;
                        ensureVisible();
                        if ( this.duels.indexOf(this.activeItem) == this.duels.length - 2 ) {
                            var ajax = this.shadowRoot.querySelector('core-ajax#before');
                            ajax.params = JSON.stringify({'before-duel': this.duels[this.duels.length - 1].id});
                            ajax.go();
                        }
                    } else {
                        this.activeItem = this.duels[0];
                        ensureVisible();
                    }
                }
                // left
                else if ( event.keyCode == 37) {
                    if ( this.duels.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.duels[this.duels.indexOf(this.activeItem) - 1] || this.activeItem;
                        ensureVisible();

                        if ( this.duels.indexOf(this.activeItem) == 0 ) {
                            var ajax = this.shadowRoot.querySelector('core-ajax#after');
                            ajax.params = JSON.stringify({'after-duel': this.duels[0].id});
                            ajax.go();
                        }
                    } else {
                        var ajax = this.shadowRoot.querySelector('core-ajax#after');
                        ajax.params = JSON.stringify({'after-duel': this.duels[0].id});
                        ajax.go();
                    }
                }
            }
        })
    </script>
</polymer-element>