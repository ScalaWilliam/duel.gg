<polymer-element name="player-card"
                 attributes="name initialJson focusDuel">
    <template>
        <div class="player">
            <template if="{{user.name}}">
                <h2>{{user.name}} ({{user.nickname}})</h2>
            </template>
            <template if="{{!(user.name)}}">
                <h2>{{user.nickname}}</h2>
            </template>
            <template if="{{!user.id}}">
                <p>Register to show more than your latest 9 duels.</p>
            </template>
            <style scoped>
                a { color: wheat;}
                .flexed ol {
                    display:flex;
                    overflow-x:scroll;
                    margin:0;
                    padding:0;
                    list-style-type: none;
                }
                ::-webkit-scrollbar {
                    width:  0.5em;
                    height: 0.5em;
                }

                ::-webkit-scrollbar-thumb {
                    background: white;
                }

                ::-webkit-scrollbar-track {
                    background: slategray;
                }
                .flexed ol li {
                    flex: 10 0 auto;
                    margin-right:1em;
                }
                .flexed ol li a {
                    display:block;
                }
                #duels ol li {
                    width:20em;
                }
                a:focus {
                    background:#1b325f;
                    outline: 0;
                }
                .hidden {
                    display:none;
                }
            </style>
            <div id="duels" class="{{ { hidden: duels.length == 0, flexed: true } | tokenList}}">
                    <ol>
                        <template repeat="{{duel in duels}}">
                            <li id="{{duel.globalId}}" class="{{ {active: duel == activeItem} | tokenList}}">
                                <mini-duel-card duelId="{{duel.id}}"
                                                contextUser="{{user.id}}"
                                                leftPlayerName="{{duel.leftPlayerName}}"
                                                rightPlayerName="{{duel.rightPlayerName}}"
                                                leftPlayerScore="{{duel.leftPlayerScore}}"
                                                rightPlayerScore="{{duel.rightPlayerScore}}"
                                                atTime="{{duel.atTime}}"
                                                mode="{{duel.mode}}"
                                                map="{{duel.map}}"></mini-duel-card>
                            </li>
                        </template>
                    </ol>
                </div>
<style scoped>
    .maps {
    }
    .maps ol {
        display:flex;
    }
    #map-stats ol {
        margin:0;
        padding:0;
        list-style-type: none;
    }
    ol.modes > li > ol {
        display:flex;
    }
    ol.modes > li > ol > li:first-child {
        min-width:6em;
        font-weight: bold;
    }
    #map-stats .maps li, .modes > li > ol > li:not(:first-child) {
        padding:2px;
        width:2em;
    }
    #map-stats .maps ol li:first-child {
        min-width:8em;
        vertical-align: middle;
        text-align: center;
        position:relative;
    }
    #map-stats .maps ol li:first-child span {
        position:absolute;
        bottom:1em;
        display:inline-block;
        left:0em;
        right:0;
        text-align: center;
    }
    #map-stats .summary {
        font-weight: bold;
    }
    #map-stats .maps > ol > li {
        height:6em;
        text-align: left;
    }
    #map-stats .maps > ol > li:not(:first-child) > span {
        transform:rotate(-90deg) translate(-4em,120%);
        transform-origin: 0 100%;
        display:inline-block;
        font-weight:bold;
    }
    #map-stats .modes li.summary ol li:not(:first-child):not(:nth-child(2)) {
        border-top:thin solid wheat;
    }
    #map-stats .modes li ol li.summary {
border-right:thin solid wheat;
    }
</style>
            <div id="map-stats" class="{{ { hidden: !stats } | tokenList}}">
                <h2>Game counts</h2>
                <div class="maps">
                    <ol>
                        <li><span><sub>mode</sub> <sup>map</sup></span></li>
                        <template repeat="{{map in stats.maps}}">
                            <li><span>{{map.map}}</span></li>
                        </template>
                    </ol>
                </div>
                <ol class="modes">
                    <template repeat="{{mode in stats.modes}}">
                    <li>
                    <ol>
                        <li>{{mode.mode}}</li>
                        <li class="summary">{{mode.count}}</li>
                        <template repeat="{{item in mode.items}}">
                            <li>{{item}}</li>
                        </template>
                    </ol>
                    </li>
                    </template>
                    <li class="summary"><ol><li></li><li>{{stats.count}}</li>
                    <template repeat="{{map in stats.maps}}"><li>{{map.count}}</li></template>
                    </ol></li>
                </ol>

            </div>

            <core-ajax id="secondary"
                       url="/json/user/{{user.id}}/"
                       params='{}'
                       handleAs="json"
                       on-core-response="{{handleResponseLazy}}"></core-ajax>
            <core-ajax id="after"
                       url="/json/user/{{user.id}}/"
                       params='{}'
                       handleAs="json"
                       on-core-response="{{handleResponseLazyAfter}}"></core-ajax>
            <template if="{{currentDuel}}">
            <duel-detailed-card duelId="{{currentDuel.id}}" atTime="{{currentDuel.atTime}}" leftPlayerScore="{{currentDuel.leftPlayerScore}}"
                                map="{{currentDuel.map}}" mode="{{currentDuel.mode}}" leftPlayerName="{{currentDuel.leftPlayerName}}"
                                rightPlayerScore="{{currentDuel.rightPlayerScore}}" rightPlayerName="{{currentDuel.rightPlayerName}}"
                                leftPlayerId="{{currentDuel.leftPlayerId}}"
                                scoreLog="{{currentDuel.scoreLog|ser}}"
                                rightPlayerId="{{currentDuel.rightPlayerId}}"
                    >
                <!-- -->
            </duel-detailed-card>
            </template>
        </div>
    </template>
    <script>
        Polymer("player-card", {
            ready: function() {
                scrollHorizons(unwrap(this.shadowRoot.querySelector('#duels ol')));
            },
            initialJsonChanged: function(_, v) {
                var json = JSON.parse(v);
                this.duels = json.duels;
                this.user = json.user;
                this.player = json.player;
                this.stats = json.stats;
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                this.duels.forEach(function(d) {
                    d.globalId = "duel-"+hashCode(d.id);
                })
            },
            activeItemChanged: function(_, v) {
                this.currentDuel = this.activeItem;
                if ( this.user.id ) {
                    window.history.replaceState(null, null, '/player/'+this.user.id+'/?duel=' + this.currentDuel.id);
                } else {
                    window.history.replaceState(null, null, '/player/?nickname='+encodeURIComponent(this.user.nickname)+'&duel='+this.currentDuel.id);
                }
            },
            focusDuelChanged: function(_, v) {
                this.currentDuel = this.duels.filter(function(d) { return d.id == v; })[0];
                this.activeItem = this.currentDuel;
                var ensureVisible = (function() {
                    if ( this.activeItem ) {
                        if ( this.duels.indexOf(this.activeItem) > -1 ) {
                            try {
                                this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' mini-duel-card').shadowRoot.querySelector('a').focus();
                            }catch(e) {}
                            try {
                                this.querySelector('::shadow #' + this.activeItem.globalId + ' mini-duel-card ::shadow a').focus();
                            } catch (e) {
                            }
                        } else {

                            this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' a').focus();
                            try {this.querySelector('::shadow #' + this.activeItem.globalId + ' a').focus();
                            } catch (e) {}
                        }

                    }
                }).bind(this);
                setTimeout(ensureVisible, 500);
            },
            ser: function(x) {
                return JSON.stringify(x);
            },
            attached: function() {
                scrollHorizons(unwrap(this.shadowRoot.querySelector('#duels ol')));
            },
            handleResponseLazy: function(a, b, c) {
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                b.response.duels.forEach(function(item) {
                    for ( var i = 0; i < this.duels.length; i++ ) {
                        if ( this.duels[i].id == item.id) return;
                    }
                    this.duels.push(item);
                    item.globalId = "duel-"+hashCode(item.id);
                }.bind(this));
            },
            handleResponseLazyAfter: function(a, b, c) {
                var hashCode = function(s){
                    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                };
                b.response.duels.reverse().forEach(function(item) {
                    for ( var i = 0; i < this.duels.length; i++ ) {
                        if ( this.duels[i].id == item.id) return;
                    }
                    this.duels.unshift(item);
                    item.globalId = "duel-"+hashCode(item.id);
                }.bind(this));
            },
            keypressHandler: function(event, detail, sender) {
                var ensureVisible = (function() {
                    if ( this.activeItem ) {
                        if ( this.duels.indexOf(this.activeItem) > -1 ) {
                            try {
                                this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' mini-duel-card').shadowRoot.querySelector('a').focus();
                            }catch(e) {}
                            try {
                                this.querySelector('::shadow #' + this.activeItem.globalId + ' mini-duel-card ::shadow a').focus();
                            } catch (e) {
                            }
                        } else {

                            this.shadowRoot.querySelector(' #' + this.activeItem.globalId + ' a').focus();
                            try {this.querySelector('::shadow #' + this.activeItem.globalId + ' a').focus();
                            } catch (e) {}
                        }

                    }
                }).bind(this);
                // right
                if ( event.keyCode == 39 ) {
                    if ( this.duels.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.duels[this.duels.indexOf(this.activeItem) + 1] || this.activeItem;
                        ensureVisible();
                        if ( this.user && this.user.id && this.duels.indexOf(this.activeItem) == this.duels.length - 2 ) {
                            var ajax = this.shadowRoot.querySelector('core-ajax#secondary');
                            ajax.params = JSON.stringify({'before-duel': this.duels[this.duels.length - 1].id});
                            ajax.go();
                        }
                    } else {
                        this.activeItem = this.duels[0];
                        ensureVisible();
                    }
                }
                // left
                else if ( event.keyCode == 37) {
                    if ( this.duels.indexOf(this.activeItem) > -1 ) {
                        event.stopPropagation();
                        this.activeItem = this.duels[this.duels.indexOf(this.activeItem) - 1] || this.activeItem;
                        ensureVisible();

                        if ( this.user && this.user.id && this.duels.indexOf(this.activeItem) == 0 ) {
                            var ajax = this.shadowRoot.querySelector('core-ajax#after');
                            ajax.params = JSON.stringify({'after-duel': this.duels[0].id});
                            ajax.go();
                        }
                    } else {
                        if ( this.user && this.user.id ) {
                            var ajax = this.shadowRoot.querySelector('core-ajax#after');
                            ajax.params = JSON.stringify({'after-duel': this.duels[0].id});
                            ajax.go();
                        }
                    }
                }
            }
        })
    </script>
</polymer-element>